parameter (or (pair address
                    (pair address
                          nat))
              address);
storage (pair (big_map address
                       (pair nat
                             (map address
                                  nat)))
              (pair nat
                    (pair string
                          string)));
code { DUP;
       CAR;
       DIP { CDR };
       IF_LEFT { DUP;
                 CAR;
                 DIP { SWAP };
                 DIP { DUP;
                       CAR };
                 GET;
                 IF_NONE { EMPTY_MAP address nat;
                           PUSH nat 0;
                           PAIR }
                         {  };
                 DUP;
                 CAR;
                 DIP { DIP { SWAP };
                       SWAP;
                       DUP;
                       CDR;
                       CDR };
                 SUB;
                 ISNAT;
                 IF_NONE { PUSH string "performTransfer: not enough tokens for transfer to";
                           FAILWITH }
                         { DIP { SWAP;
                                 CDR };
                           PAIR };
                 SOME;
                 DIP { DUP;
                       CAR };
                 SWAP;
                 DIP { DIP { DIP { DUP;
                                   CAR };
                             SWAP } };
                 UPDATE;
                 DIP { DUP;
                       CDR;
                       CAR };
                 DUP;
                 DIP { SWAP };
                 SWAP;
                 GET;
                 IF_NONE { EMPTY_MAP address nat;
                           PUSH nat 0;
                           PAIR }
                         {  };
                 DIP { SWAP;
                       DUP;
                       CDR;
                       CDR };
                 SWAP;
                 DIP { DUP;
                       CAR };
                 ADD;
                 DIP { CDR };
                 PAIR;
                 SWAP;
                 CDR;
                 CAR;
                 DIP { SOME };
                 UPDATE;
                 DIP { DUP;
                       DIP { CDR };
                       CAR };
                 DIP { DROP };
                 PAIR;
                 NIL operation;
                 PAIR }
               { DIP { DUP;
                       CAR };
                 GET;
                 IF_NONE { PUSH nat 0 }
                         { CAR };
                 RIGHT (pair address (contract (or (pair address (pair address nat)) address)));
                 DIP { SENDER;
                       CONTRACT (or (pair address (contract (or (pair address (pair address nat)) address))) nat);
                       IF_NONE { PUSH string "GetBalance: sender contract does not match the expected type, first try.";
                                 FAILWITH }
                               {  };
                       PUSH mutez 0 };
                 TRANSFER_TOKENS;
                 NIL operation;
                 SWAP;
                 CONS;
                 PAIR } };